/**
 * ============================================================================
 * –ë–ï–ù–ß–ú–ê–†–ö –î–õ–Ø BLAKE3: –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–π
 * ============================================================================
 * 
 * –§–∞–π–ª: benchmark.ts
 * –Ø–∑—ã–∫: TypeScript
 * –°—Ä–µ–¥–∞: Deno (https://deno.land)
 * 
 * –ó–∞–ø—É—Å–∫:
 * 
 *   # Deno 2.x (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω—É–∂–Ω—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º)
 *   deno bench --allow-read --allow-import --allow-env benchmark.ts
 * 
 *   # Deno 1.x (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
 *   deno bench --allow-read --allow-net benchmark.ts
 * 
 *   # –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)
 *   deno bench --allow-all benchmark.ts
 * 
 * –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
 *   –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–π
 *   –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 */

// ============================================================================
// –ò–ú–ü–û–†–¢–´
// ============================================================================

/**
 * BLAKE3 —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ Rust –≤ WebAssembly.
 * –≠—Ç–æ –Ω–∞—à —ç—Ç–∞–ª–æ–Ω - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.
 * –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –ø—É—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π, 
 * —Ç–∞–∫ –∫–∞–∫ –º—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ WASM.
 */

import { hash as rustWasmHash } from "npm:blake3-wasm@2.1.5";

/**
 * SHA-256 –Ω–∞ —á–∏—Å—Ç–æ–º JavaScript.
 * –ö–ª–∞—Å—Å–∏–∫–∞ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –°–ª—É–∂–∏—Ç —Ç–æ—á–∫–æ–π –æ—Ç—Å—á—ë—Ç–∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
 * "—Ç–∏–ø–∏—á–Ω–æ–π" –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ JS-—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
import { sha256 } from "https://denopkg.com/chiefbiiko/sha256@v1.0.0/mod.ts";

/**
 * BLAKE3 –Ω–∞ JavaScript –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 */
import { blake3 as jsHashV0 } from "./js/v0.js";
import { blake3 as jsHashV00 } from "./js/v00.ts";

import { hash as jsHashVT0 } from "./js/vt0.ts";
import { hash as jsHashVT1 } from "./js/vt1.js";
import { hash as jsHashVT2 } from "./js/vt2.ts";
import { hash as jsHashVT3 } from './js/vt3_simd-4-fast.ts';
import { hash as jsHashVT4 } from "./js/vt4.js";

import { blake3 as jsBlake3HashV1 } from "./js/v1.js";
import { hash as jsBlake3HashV2 } from "./js/v2.js";
import { hash as jsBlake3HashV3 } from "./js/v3.js";
import { hash as jsBlake3HashV4 } from "./js/v4.js";
import { hash as jsBlake3HashV5 } from "./js/v5.js";
import { hash as jsBlake3HashV6 } from "./js/v6.js";
import { hash as jsBlake3HashV7 } from "./js/v7.js";
import { hash as jsBlake3HashV8 } from "./js/v8.js";
import { hash as jsBlake3HashV9 } from "./js/v9_ru.js";


// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================================

/**
 * –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
 * 
 * "pseudo"  - Math.random() 
 *             –ë—ã—Å—Ç—Ä–æ, –Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–µ–Ω—á–º–∞—Ä–∫–æ–≤.
 * 
 * "crypto"  - crypto.getRandomValues()
 *             –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ú–µ–¥–ª–µ–Ω–Ω–µ–µ,
 *             –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–∏–Ω–Ω—É—é —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å.
 * 
 * "both"    - –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
 */
type RandomMode = "pseudo" | "crypto" | "both";
const RANDOM_MODE = "both" as RandomMode;

/**
 * –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –≤ –±–∞–π—Ç–∞—Ö.
 * 1 –ú–ë - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤,
 * –Ω–æ –Ω–µ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∑–∞–º–µ–¥–ª–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.
 */
const BUFFER_SIZE = 1024 * 1024; // 1 –ú–ë

// ============================================================================
// –¢–ï–°–¢–û–í–´–ï –†–ê–ó–ú–ï–†–´
// ============================================================================

/**
 * –°–ø–µ–∫—Ç—Ä —Ä–∞–∑–º–µ—Ä–æ–≤ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 * 
 * –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è?
 * 
 * 96B     - –ú–µ–Ω—å—à–µ –æ–¥–Ω–æ–π –∫—ç—à-–ª–∏–Ω–∏–∏ CPU (–æ–±—ã—á–Ω–æ 64 –±–∞–π—Ç–∞).
 *           –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∏—Å—Ç—ã–π overhead –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–∏.
 * 
 * 512B    - –¢–∏–ø–∏—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–µ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –∏–ª–∏ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
 * 
 * 1 KiB   - –ú–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ –¥–ª—è BLAKE3: —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞.
 *           –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–º–µ–Ω–Ω–æ –ø–æ–¥ —ç—Ç–æ—Ç —Ä–∞–∑–º–µ—Ä.
 * 
 * 32 KiB  - –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä L1-–∫—ç—à–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –º–Ω–æ–≥–∏—Ö CPU.
 *           –î–∞–Ω–Ω—ã–µ –µ—â—ë "–≥–æ—Ä—è—á–∏–µ", –¥–æ—Å—Ç—É–ø –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π.
 * 
 * 64 KiB  - –ì—Ä–∞–Ω–∏—Ü–∞ L1. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–º–µ—á–∞—Ç—å –ø—Ä–æ–º–∞—Ö–∏ –∫—ç—à–∞.
 * 
 * 256 KiB - –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è L2-–∫—ç—à–∞. –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç.
 * 
 * 1 MB    - –ü–æ—á—Ç–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –≤—ã–ª–µ–∑–∞–µ–º –∑–∞ L2.
 *           –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "—á–µ—Å—Ç–Ω—É—é" –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
 */
const BENCH_SIZES: Array<[string, number]> = [
  ["96B", 96],
  ["512B", 512],
  ["1KiB", 1 * 1024],
  ["32KiB", 32 * 1024],
  ["64KiB", 64 * 1024],
  ["256KiB", 256 * 1024],
  ["1MB", 1024 * 1024],
];

// ============================================================================
// –ì–ï–ù–ï–†–ê–¢–û–†–´ –°–õ–£–ß–ê–ô–ù–´–• –î–ê–ù–ù–´–•
// ============================================================================

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –±—É—Ñ–µ—Ä –ü–°–ï–í–î–û–°–õ–£–ß–ê–ô–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏.
 * 
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Math.random() - –±—ã—Å—Ç—Ä—ã–π, –Ω–æ –Ω–µ –∫—Ä–∏–ø—Ç–æ—Å—Ç–æ–π–∫–∏–π 
 * –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª.
 * –î–ª—è –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: –Ω–∞–º –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è,
 * –∞ –Ω–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 * 
 * –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ 4 –±–∞–π—Ç–∞ –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é,
 * –∏–∑–≤–ª–µ–∫–∞—è –∏—Ö –∏–∑ –æ–¥–Ω–æ–≥–æ —á–∏—Å–ª–∞ —á–µ—Ä–µ–∑ –±–∏—Ç–æ–≤—ã–µ —Å–¥–≤–∏–≥–∏.
 * 
 * @param buffer - Uint8Array –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
 */
function fillWithPseudoRandom(buffer: Uint8Array): void {
  for (let i = 0; i < buffer.length; ) {
    // Math.random() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç float –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1)
    // –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ MAX_SAFE_INTEGER, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ~53 –±–∏—Ç–∞ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
    let rng = Math.random() * Number.MAX_SAFE_INTEGER;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º 4 –±–∞–π—Ç–∞ –∏–∑ —á–∏—Å–ª–∞
    for (let j = 0; j < 4 && i < buffer.length; ++j) {
      buffer[i++] = rng & 0xff;  // –ë–µ—Ä—ë–º –º–ª–∞–¥—à–∏–µ 8 –±–∏—Ç
      rng >>= 8;                  // –°–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ –Ω–∞ 8 –±–∏—Ç
    }
  }
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –±—É—Ñ–µ—Ä –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–ß–ï–°–ö–ò –°–¢–û–ô–ö–ò–ú–ò —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * 
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç crypto.getRandomValues() - —Å–∏—Å—Ç–µ–º–Ω—ã–π –ì–ü–°–ß,
 * –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ª–µ–π.
 * 
 * –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º Math.random(), –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
 * - –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å
 * - –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
 * - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
 * 
 * –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 65536 –±–∞–π—Ç.
 * –î–ª—è –±–æ–ª—å—à–∏—Ö –±—É—Ñ–µ—Ä–æ–≤ –≤—ã–∑—ã–≤–∞–µ–º –≤ —Ü–∏–∫–ª–µ.
 * 
 * @param buffer - Uint8Array –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
 */
function fillWithCryptoRandom(buffer: Uint8Array): void {
  const MAX_CHUNK = 65536; // –õ–∏–º–∏—Ç crypto.getRandomValues()
  
  for (let offset = 0; offset < buffer.length; offset += MAX_CHUNK) {
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–∫–∞
    const remaining = buffer.length - offset;
    const chunkSize = Math.min(remaining, MAX_CHUNK);
    
    // –°–æ–∑–¥–∞—ë–º view –Ω–∞ –Ω—É–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –±—É—Ñ–µ—Ä–∞
    const chunk = new Uint8Array(buffer.buffer, offset, chunkSize);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–º–∏ —Å–ª—É—á–∞–π–Ω—ã–º–∏ –±–∞–π—Ç–∞–º–∏
    crypto.getRandomValues(chunk);
  }
}

// ============================================================================
// –ü–û–î–ì–û–¢–û–í–ö–ê –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•
// ============================================================================

/**
 * –°–æ–∑–¥–∞—ë—Ç –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –±–µ–Ω—á–º–∞—Ä–∫–∞.
 * 
 * –ö–ª—é—á–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –≤—Å–µ "—Ä–∞–∑–º–µ—Ä—ã" - —ç—Ç–æ view'—ã –Ω–∞ –æ–¥–∏–Ω –æ–±—â–∏–π –±—É—Ñ–µ—Ä.
 * –ú—ã –Ω–µ –∫–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ, –∞ –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–∞–∑–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏.
 * 
 * @param fillFunction - –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
 * @param label - –ú–µ—Ç–∫–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–±–æ—Ä–∞ ("pseudo" –∏–ª–∏ "crypto")
 * @returns –ú–∞—Å—Å–∏–≤ –ø–∞—Ä [—á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä, –±—É—Ñ–µ—Ä]
 */
function prepareBenchCases(
  fillFunction: (buffer: Uint8Array) => void,
  label: string
): Array<[string, Uint8Array, string]> {
  // –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—ã–π –±—É—Ñ–µ—Ä
  const mainBuffer = new Uint8Array(BUFFER_SIZE);
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  fillFunction(mainBuffer);
  
  // –°–æ–∑–¥–∞—ë–º view'—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
  return BENCH_SIZES.map(([humanSize, length]) => {
    // View –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ ArrayBuffer, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å
    const view = new Uint8Array(mainBuffer.buffer, 0, length);
    return [humanSize, view, label];
  });
}

// ============================================================================
// –ó–ê–ü–£–°–ö –ë–ï–ù–ß–ú–ê–†–ö–û–í
// ============================================================================

/**
 * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–µ—Ä–∏—é –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –¥–ª—è –æ–¥–Ω–æ–π —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–∏.
 * 
 * Deno.bench –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
 * - –ü—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç JIT-–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä (warmup)
 * - –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
 * - –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—Å—Ä–µ–¥–Ω–µ–µ, –º–µ–¥–∏–∞–Ω–∞, p75, p99)
 * - –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
 * 
 * @param name - –ù–∞–∑–≤–∞–Ω–∏–µ —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–∏ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
 * @param fn - –°–∞–º–∞ —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏—è
 * @param cases - –ú–∞—Å—Å–∏–≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤
 */
function runBench(
  name: string,
  fn: (data: Uint8Array) => unknown,
  cases: Array<[string, Uint8Array, string]>
): void {
  for (const [size, input, randomLabel] of cases) {
    Deno.bench({
      // –ò–º—è —Ç–µ—Å—Ç–∞: "SHA-256 [crypto] 1KiB"
      name: `${name} [${randomLabel}] ${size}`,
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: —Ç–µ—Å—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º group –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ
      // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –æ–¥–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
      group: `${size} (${randomLabel})`,
      
      // –°–∞–º–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–µ–Ω—á–º–∞—Ä–∫–∞
      fn() {
        fn(input);
      },
    });
  }
}

// ============================================================================
// –ì–õ–ê–í–ù–´–ô –ë–õ–û–ö: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ó–ê–ü–£–°–ö
// ============================================================================

// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –Ω–∞–±–æ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
const testSuites: Array<{
  cases: Array<[string, Uint8Array, string]>;
  label: string;
}> = [];

if (RANDOM_MODE === "pseudo" || RANDOM_MODE === "both") {
  console.log("üìä –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (Math.random)");
  testSuites.push({
    cases: prepareBenchCases(fillWithPseudoRandom, "pseudo"),
    label: "pseudo",
  });
}

if (RANDOM_MODE === "crypto" || RANDOM_MODE === "both") {
  console.log("üîê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (crypto)");
  testSuites.push({
    cases: prepareBenchCases(fillWithCryptoRandom, "crypto"),
    label: "crypto",
  });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
for (const suite of testSuites) {
  console.log(`\nüèÅ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ [${suite.label}]...\n`);
  
  // SHA-256: –Ω–∞—à baseline
  runBench("SHA-256", sha256, suite.cases);
  
  // BLAKE3 Rust/WASM: –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-Rust", rustWasmHash, suite.cases);
  
  // BLAKE3 JS v0: –Ω–∞—à–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  //runBench("BLAKE3-JS-v0", jsHashV0, suite.cases);

  // BLAKE3 TS v00: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è paulmillr/noble-hashes (Paul Miller) 
  // https://github.com/paulmillr/noble-hashes/blob/main/src/blake3.ts
  runBench("BLAKE3-TS-v00 @paulmillr/noble-hashes", jsHashV00, suite.cases);


  // BLAKE3 JS test 0: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è fleek-network/blake3js-perf
  // https://github.com/fleek-network/blake3js-perf/blob/main/js/latest.ts
  runBench("BLAKE3-TS-test-0 @fleek-network/blake3js-perf", jsHashVT0, suite.cases);

  // BLAKE3 JS test 1: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è lamb356/blake3-optimized
  // https://github.com/lamb356/blake3-optimized/blob/main/blake3.js
  runBench("BLAKE3-JS-test-1 @lamb356/blake3-optimized", jsHashVT1, suite.cases);
  
  // BLAKE3 JS test 2: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è alrightCha/blake3-js
  // https://github.com/alrightCha/blake3-js/blob/main/js/blake3.ts
  runBench("BLAKE3-TS-test-2 @alrightCha/blake3-js", jsHashVT2, suite.cases);
  
  // BLAKE3 JS test 3: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Atamanov/blake3-fast 
  // https://github.com/Atamanov/blake3-fast/blob/main/src/simd-4-fast.ts
  runBench("BLAKE3-TS-test-3 @Atamanov/blake3-fast", jsHashVT3, suite.cases);
  
  // BLAKE3 JS test 4: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è chimmykk/Bk3JS
  // https://github.com/chimmykk/Bk3JS/blob/main/blake3.js
  runBench("BLAKE3-JS-test-4 @chimmykk/Bk3JS", jsHashVT4, suite.cases);
  
  // BLAKE3 JS v1: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  //runBench("BLAKE3-JS-v1", jsBlake3HashV1, suite.cases);
  
  // BLAKE3 JS v2: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  //runBench("BLAKE3-JS-v2", jsBlake3HashV2, suite.cases);
  
  // BLAKE3 JS v3: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  //runBench("BLAKE3-JS-v3", jsBlake3HashV3, suite.cases);
  
  // BLAKE3 JS v4: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  //runBench("BLAKE3-JS-v4", jsBlake3HashV4, suite.cases);
  
  // BLAKE3 JS v5: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-JS-v5", jsBlake3HashV5, suite.cases);
  
  // BLAKE3 JS v6: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-JS-v6", jsBlake3HashV6, suite.cases);
  
  // BLAKE3 JS v7: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-JS-v7", jsBlake3HashV7, suite.cases);
  
  // BLAKE3 JS v8: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-JS-v8", jsBlake3HashV8, suite.cases);
  
  // BLAKE3 JS v9: –Ω–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  runBench("BLAKE3-JS-v9", jsBlake3HashV9, suite.cases);
  
}

// ============================================================================
// –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø
// ============================================================================

/**
 * –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:
 * 
 * Deno.bench –≤—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É –≤–∏–¥–∞:
 * 
 * benchmark                        time (avg)        iter/s
 * --------------------------------------------------------
 * SHA-256 [pseudo] 1KiB            14.2 ¬µs/iter    70,260
 * BLAKE3-Rust [pseudo] 1KiB         2.6 ¬µs/iter   384,000
 * 
 * –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
 * - time (avg): —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–¥–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
 * - iter/s: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É (–±–æ–ª—å—à–µ = –ª—É—á—à–µ)
 * 
 * 
 * –ü–û–ß–ï–ú–£ –î–í–ê –ì–ï–ù–ï–†–ê–¢–û–†–ê?
 * 
 * 1. –ü—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Math.random):
 *    + –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
 *    + –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å (–ø—Ä–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º seed)
 *    - –ú–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã
 * 
 * 2. –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (crypto.getRandomValues):
 *    + –ò—Å—Ç–∏–Ω–Ω–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
 *    + –ù–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è "—ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏" –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–æ–º
 *    - –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è
 * 
 * –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–ª—å–Ω–æ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è - —ç—Ç–æ —Å–∏–≥–Ω–∞–ª, —á—Ç–æ —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏—è
 * –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ —Å–µ–±—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞—Ö –¥–∞–Ω–Ω—ã—Ö.
 */
